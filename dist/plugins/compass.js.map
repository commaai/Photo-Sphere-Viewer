{"version":3,"file":"compass.js","sources":["../../src/plugins/compass/index.js"],"sourcesContent":["import { MathUtils } from 'three';\nimport { AbstractPlugin, CONSTANTS, SYSTEM, utils } from '../..';\nimport compass from './compass.svg';\nimport './style.scss';\n\n\n/**\n * @typedef {Object} PSV.plugins.CompassPlugin.Options\n * @property {string} [size='120px'] - size of the compass\n * @property {string} [position='top left'] - position of the compass\n * @property {string} [backgroundSvg] - SVG used as background of the compass\n * @property {string} [coneColor='rgba(255, 255, 255, 0.5)'] - color of the cone of the compass\n * @property {boolean} [navigation=true] - allows to click on the compass to rotate the viewer\n * @property {string} [navigationColor='rgba(255, 0, 0, 0.2)'] - color of the navigation cone\n * @property {PSV.plugins.CompassPlugin.Hotspot[]} [hotspots] - small dots visible on the compass (will contain every marker with the \"compass\" data)\n * @property {string} [hotspotColor='rgba(0, 0, 0, 0.5)'] - default color of hotspots\n */\n\n/**\n * @typedef {PSV.ExtendedPosition} PSV.plugins.CompassPlugin.Hotspot\n * @type {string} [color] - override the global \"hotspotColor\"\n */\n\n\nconst HOTSPOT_SIZE_RATIO = 1 / 40;\n\n\n/**\n * @summary Adds a compass on the viewer\n * @extends PSV.plugins.AbstractPlugin\n * @memberof PSV.plugins\n */\nexport class CompassPlugin extends AbstractPlugin {\n\n  static id = 'compass';\n\n  /**\n   * @param {PSV.Viewer} psv\n   * @param {PSV.plugins.CompassPlugin.Options} options\n   */\n  constructor(psv, options) {\n    super(psv);\n\n    /**\n     * @member {PSV.plugins.CompassPlugin.Options}\n     * @private\n     */\n    this.config = {\n      size           : '120px',\n      backgroundSvg  : compass,\n      coneColor      : 'rgba(255, 255, 255, 0.5)',\n      navigation     : true,\n      navigationColor: 'rgba(255, 0, 0, 0.2)',\n      hotspotColor   : 'rgba(0, 0, 0, 0.5)',\n      ...options,\n      position       : utils.cleanPosition(options.position, { allowCenter: true, cssOrder: true }) || ['top', 'left'],\n    };\n\n    /**\n     * @private\n     */\n    this.prop = {\n      visible  : true,\n      mouse    : null,\n      mouseDown: false,\n      markers  : [],\n    };\n\n    /**\n     * @type {PSV.plugins.MarkersPlugin}\n     * @private\n     */\n    this.markers = null;\n\n    /**\n     * @member {HTMLElement}\n     * @readonly\n     * @private\n     */\n    this.container = document.createElement('div');\n    this.container.className = `psv-compass psv-compass--${this.config.position.join('-')}`;\n    this.container.innerHTML = this.config.backgroundSvg;\n\n    this.container.style.width = this.config.size;\n    this.container.style.height = this.config.size;\n    if (this.config.position[0] === 'center') {\n      this.container.style.marginTop = `calc(-${this.config.size} / 2)`;\n    }\n    if (this.config.position[1] === 'center') {\n      this.container.style.marginLeft = `calc(-${this.config.size} / 2)`;\n    }\n\n    /**\n     * @member {HTMLCanvasElement}\n     * @readonly\n     * @private\n     */\n    this.canvas = document.createElement('canvas');\n\n    this.container.appendChild(this.canvas);\n\n    if (this.config.navigation) {\n      this.container.addEventListener('mouseenter', this);\n      this.container.addEventListener('mouseleave', this);\n      this.container.addEventListener('mousemove', this);\n      this.container.addEventListener('mousedown', this);\n      this.container.addEventListener('mouseup', this);\n      this.container.addEventListener('touchstart', this);\n      this.container.addEventListener('touchmove', this);\n      this.container.addEventListener('touchend', this);\n    }\n  }\n\n  /**\n   * @package\n   */\n  init() {\n    super.init();\n\n    this.markers = this.psv.getPlugin('markers');\n\n    this.psv.container.appendChild(this.container);\n\n    this.canvas.width = this.container.clientWidth * SYSTEM.pixelRatio;\n    this.canvas.height = this.container.clientWidth * SYSTEM.pixelRatio;\n\n    this.psv.on(CONSTANTS.EVENTS.RENDER, this);\n\n    if (this.markers) {\n      this.markers.on('set-markers', this);\n    }\n  }\n\n  /**\n   * @package\n   */\n  destroy() {\n    this.psv.off(CONSTANTS.EVENTS.RENDER, this);\n\n    if (this.markers) {\n      this.markers.off('set-markers', this);\n    }\n\n    this.psv.container.removeChild(this.container);\n\n    delete this.canvas;\n    delete this.container;\n\n    super.destroy();\n  }\n\n  /**\n   * @private\n   */\n  handleEvent(e) {\n    switch (e.type) {\n      case CONSTANTS.EVENTS.RENDER:\n        this.__update();\n        break;\n      case 'set-markers':\n        this.prop.markers = e.args[0].filter(m => m.data?.compass);\n        this.__update();\n        break;\n      case 'mouseenter':\n      case 'mousemove':\n      case 'touchmove':\n        this.prop.mouse = e.changedTouches?.[0] || e;\n        if (this.prop.mouseDown) {\n          this.__click();\n        }\n        else {\n          this.__update();\n        }\n        e.stopPropagation();\n        e.preventDefault();\n        break;\n      case 'mousedown':\n      case 'touchstart':\n        this.prop.mouseDown = true;\n        e.stopPropagation();\n        e.preventDefault();\n        break;\n      case 'mouseup':\n      case 'touchend':\n        this.prop.mouse = e.changedTouches?.[0] || e;\n        this.prop.mouseDown = false;\n        this.__click();\n        if (e.changedTouches) {\n          this.prop.mouse = null;\n          this.__update();\n        }\n        e.stopPropagation();\n        e.preventDefault();\n        break;\n      case 'mouseleave':\n        this.prop.mouse = null;\n        this.prop.mouseDown = false;\n        this.__update();\n        break;\n      default:\n        break;\n    }\n  }\n\n  /**\n   * @summary Hides the compass\n   */\n  hide() {\n    this.container.style.display = 'none';\n    this.prop.visible = false;\n  }\n\n  /**\n   * @summary Shows the compass\n   */\n  show() {\n    this.container.style.display = '';\n    this.prop.visible = true;\n  }\n\n  /**\n   * @summary Changes the hotspots on the compass\n   * @param {PSV.plugins.CompassPlugin.Hotspot[]} hotspots\n   */\n  setHotspots(hotspots) {\n    this.config.hotspots = hotspots;\n    this.__update();\n  }\n\n  /**\n   * @summary Removes all hotspots\n   */\n  clearHotspots() {\n    this.setHotspots(null);\n  }\n\n  /**\n   * @summary Updates the compass for current zoom and position\n   * @private\n   */\n  __update() {\n    const context = this.canvas.getContext('2d');\n    context.clearRect(0, 0, this.canvas.width, this.canvas.height);\n\n    const longitude = this.psv.getPosition().longitude;\n    const fov = MathUtils.degToRad(this.psv.prop.hFov);\n\n    this.__drawCone(context, this.config.coneColor, longitude, fov);\n\n    const mouseAngle = this.__getMouseAngle();\n    if (mouseAngle !== null) {\n      this.__drawCone(context, this.config.navigationColor, mouseAngle, fov);\n    }\n\n    this.prop.markers.forEach((marker) => {\n      this.__drawMarker(context, marker);\n    });\n    this.config.hotspots?.forEach((spot) => {\n      if ('longitude' in spot && !('latitude' in spot)) {\n        spot.latitude = 0;\n      }\n      const pos = this.psv.dataHelper.cleanPosition(spot);\n      this.__drawPoint(context, spot.color || this.config.hotspotColor, pos.longitude, pos.latitude);\n    });\n  }\n\n  /**\n   * @summary Rotates the viewer depending on the position of the mouse on the compass\n   * @private\n   */\n  __click() {\n    const mouseAngle = this.__getMouseAngle();\n\n    if (mouseAngle !== null) {\n      this.psv.rotate({\n        longitude: mouseAngle,\n        latitude : 0,\n      });\n    }\n  }\n\n  /**\n   * @summary Draw a cone\n   * @param {CanvasRenderingContext2D} context\n   * @param {string} color\n   * @param {number} longitude - in viewer reference\n   * @param {number} fov\n   * @private\n   */\n  __drawCone(context, color, longitude, fov) {\n    const a1 = longitude - Math.PI / 2 - fov / 2;\n    const a2 = a1 + fov;\n    const c = this.canvas.width / 2;\n\n    context.beginPath();\n    context.moveTo(c, c);\n    context.lineTo(c + Math.cos(a1) * c, c + Math.sin(a1) * c);\n    context.arc(c, c, c, a1, a2, false);\n    context.lineTo(c, c);\n    context.fillStyle = color;\n    context.fill();\n  }\n\n  /**\n   * @summary Draw a Marker\n   * @param {CanvasRenderingContext2D} context\n   * @param {PSV.plugins.MarkersPlugin.Marker} marker\n   * @private\n   */\n  __drawMarker(context, marker) {\n    let color = this.config.hotspotColor;\n    if (typeof marker.data.compass === 'string') {\n      color = marker.data.compass;\n    }\n\n    if (marker.isPoly()) {\n      context.beginPath();\n      marker.props.def.forEach(([longitude, latitude], i) => {\n        const a = longitude - Math.PI / 2;\n        const d = (latitude + Math.PI / 2) / Math.PI;\n        const c = this.canvas.width / 2;\n\n        context[i === 0 ? 'moveTo' : 'lineTo'](c + Math.cos(a) * c * d, c + Math.sin(a) * c * d);\n      });\n      if (marker.isPolygon()) {\n        context.fillStyle = color;\n        context.fill();\n      }\n      else {\n        context.strokeStyle = color;\n        context.lineWidth = Math.max(1, this.canvas.width * HOTSPOT_SIZE_RATIO / 2);\n        context.stroke();\n      }\n    }\n    else {\n      const pos = marker.props.position;\n      this.__drawPoint(context, color, pos.longitude, pos.latitude);\n    }\n  }\n\n  /**\n   * @summary Draw a point\n   * @param {CanvasRenderingContext2D} context\n   * @param {string} color\n   * @param {number} longitude - in viewer reference\n   * @param {number} latitude - in viewer reference\n   * @private\n   */\n  __drawPoint(context, color, longitude, latitude) {\n    const a = longitude - Math.PI / 2;\n    const d = (latitude + Math.PI / 2) / Math.PI;\n    const c = this.canvas.width / 2;\n    const r = Math.max(2, this.canvas.width * HOTSPOT_SIZE_RATIO);\n\n    context.beginPath();\n    context.ellipse(\n      c + Math.cos(a) * c * d, c + Math.sin(a) * c * d,\n      r, r,\n      0, 0, Math.PI * 2\n    );\n    context.fillStyle = color;\n    context.fill();\n  }\n\n  /**\n   * @summary Gets the longitude corresponding to the mouse position on the compass\n   * @return {number | null}\n   * @private\n   */\n  __getMouseAngle() {\n    if (!this.prop.mouse) {\n      return null;\n    }\n\n    const boundingRect = this.container.getBoundingClientRect();\n    const mouseX = this.prop.mouse.clientX - boundingRect.left - boundingRect.width / 2;\n    const mouseY = this.prop.mouse.clientY - boundingRect.top - boundingRect.width / 2;\n\n    if (Math.sqrt(mouseX * mouseX + mouseY * mouseY) > boundingRect.width / 2) {\n      return null;\n    }\n\n    return Math.atan2(mouseY, mouseX) + Math.PI / 2;\n  }\n\n}\n"],"names":["HOTSPOT_SIZE_RATIO","CompassPlugin","psv","options","config","size","backgroundSvg","compass","coneColor","navigation","navigationColor","hotspotColor","position","utils","cleanPosition","allowCenter","cssOrder","prop","visible","mouse","mouseDown","markers","container","document","createElement","className","join","innerHTML","style","width","height","marginTop","marginLeft","canvas","appendChild","addEventListener","init","getPlugin","clientWidth","SYSTEM","pixelRatio","on","CONSTANTS","EVENTS","RENDER","destroy","off","removeChild","handleEvent","e","type","__update","args","filter","m","data","changedTouches","__click","stopPropagation","preventDefault","hide","display","show","setHotspots","hotspots","clearHotspots","context","getContext","clearRect","longitude","getPosition","fov","MathUtils","degToRad","hFov","__drawCone","mouseAngle","__getMouseAngle","forEach","marker","__drawMarker","spot","latitude","pos","dataHelper","__drawPoint","color","rotate","a1","Math","PI","a2","c","beginPath","moveTo","lineTo","cos","sin","arc","fillStyle","fill","isPoly","props","def","i","a","d","isPolygon","strokeStyle","lineWidth","max","stroke","r","ellipse","boundingRect","getBoundingClientRect","mouseX","clientX","left","mouseY","clientY","top","sqrt","atan2","AbstractPlugin","id"],"mappings":"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"}