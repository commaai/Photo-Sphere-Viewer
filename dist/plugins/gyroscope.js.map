{"version":3,"file":"gyroscope.js","sources":["../../src/plugins/gyroscope/constants.js","../../src/plugins/gyroscope/DeviceOrientationControls.js","../../src/plugins/gyroscope/GyroscopeButton.js","../../src/plugins/gyroscope/index.js"],"sourcesContent":["/**\n * @summary Available events\n * @enum {string}\n * @memberof PSV.plugins.GyroscopePlugin\n * @constant\n */\nexport const EVENTS = {\n  /**\n   * @event gyroscope-updated\n   * @memberof PSV.plugins.GyroscopePlugin\n   * @summary Triggered when the gyroscope mode is enabled/disabled\n   * @param {boolean} enabled\n   */\n  GYROSCOPE_UPDATED: 'gyroscope-updated',\n};\n","import {\n  Euler,\n  MathUtils,\n  Quaternion,\n  Vector3\n} from 'three';\n\nconst _zee = new Vector3( 0, 0, 1 );\nconst _euler = new Euler();\nconst _q0 = new Quaternion();\nconst _q1 = new Quaternion( - Math.sqrt( 0.5 ), 0, 0, Math.sqrt( 0.5 ) ); // - PI/2 around the x-axis\n\n/**\n * Copied from three.js examples before deletion in r134\n * (deleted because of constructors/OS inconsistencies)\n * @private\n */\nclass DeviceOrientationControls {\n\n  constructor( object ) {\n\n    if ( window.isSecureContext === false ) {\n\n      console.error( 'THREE.DeviceOrientationControls: DeviceOrientationEvent is only available in secure contexts (https)' );\n\n    }\n\n    const scope = this;\n\n    const EPS = 0.000001;\n    const lastQuaternion = new Quaternion();\n\n    this.object = object;\n    this.object.rotation.reorder( 'YXZ' );\n\n    this.enabled = true;\n\n    this.deviceOrientation = {};\n    this.screenOrientation = 0;\n\n    this.alphaOffset = 0; // radians\n\n    const onDeviceOrientationChangeEvent = function ( event ) {\n\n      scope.deviceOrientation = event;\n\n    };\n\n    const onScreenOrientationChangeEvent = function () {\n\n      scope.screenOrientation = window.orientation || 0;\n\n    };\n\n    // The angles alpha, beta and gamma form a set of intrinsic Tait-Bryan angles of type Z-X'-Y''\n\n    const setObjectQuaternion = function ( quaternion, alpha, beta, gamma, orient ) {\n\n      _euler.set( beta, alpha, - gamma, 'YXZ' ); // 'ZXY' for the device, but 'YXZ' for us\n\n      quaternion.setFromEuler( _euler ); // orient the device\n\n      quaternion.multiply( _q1 ); // camera looks out the back of the device, not the top\n\n      quaternion.multiply( _q0.setFromAxisAngle( _zee, - orient ) ); // adjust for screen orientation\n\n    };\n\n    this.connect = function () {\n\n      onScreenOrientationChangeEvent(); // run once on load\n\n      // iOS 13+\n\n      if ( window.DeviceOrientationEvent !== undefined && typeof window.DeviceOrientationEvent.requestPermission === 'function' ) {\n\n        window.DeviceOrientationEvent.requestPermission().then( function ( response ) {\n\n          if ( response == 'granted' ) {\n\n            window.addEventListener( 'orientationchange', onScreenOrientationChangeEvent );\n            window.addEventListener( 'deviceorientation', onDeviceOrientationChangeEvent );\n\n          }\n\n        } ).catch( function ( error ) {\n\n          console.error( 'THREE.DeviceOrientationControls: Unable to use DeviceOrientation API:', error );\n\n        } );\n\n      } else {\n\n        window.addEventListener( 'orientationchange', onScreenOrientationChangeEvent );\n        window.addEventListener( 'deviceorientation', onDeviceOrientationChangeEvent );\n\n      }\n\n      scope.enabled = true;\n\n    };\n\n    this.disconnect = function () {\n\n      window.removeEventListener( 'orientationchange', onScreenOrientationChangeEvent );\n      window.removeEventListener( 'deviceorientation', onDeviceOrientationChangeEvent );\n\n      scope.enabled = false;\n\n    };\n\n    this.update = function () {\n\n      if ( scope.enabled === false ) return;\n\n      const device = scope.deviceOrientation;\n\n      if ( device ) {\n\n        const alpha = device.alpha ? MathUtils.degToRad( device.alpha ) + scope.alphaOffset : 0; // Z\n\n        const beta = device.beta ? MathUtils.degToRad( device.beta ) : 0; // X'\n\n        const gamma = device.gamma ? MathUtils.degToRad( device.gamma ) : 0; // Y''\n\n        const orient = scope.screenOrientation ? MathUtils.degToRad( scope.screenOrientation ) : 0; // O\n\n        setObjectQuaternion( scope.object.quaternion, alpha, beta, gamma, orient );\n\n        if ( 8 * ( 1 - lastQuaternion.dot( scope.object.quaternion ) ) > EPS ) {\n\n          lastQuaternion.copy( scope.object.quaternion );\n\n        }\n\n      }\n\n    };\n\n    this.dispose = function () {\n\n      scope.disconnect();\n\n    };\n\n    this.connect();\n\n  }\n\n}\n\nexport { DeviceOrientationControls };\n","import { AbstractButton } from '../..';\nimport compass from './compass.svg';\nimport { EVENTS } from './constants';\n\n/**\n * @summary Navigation bar gyroscope button class\n * @extends PSV.buttons.AbstractButton\n * @memberof PSV.buttons\n */\nexport class GyroscopeButton extends AbstractButton {\n\n  static id = 'gyroscope';\n  static icon = compass;\n\n  /**\n   * @param {PSV.components.Navbar} navbar\n   */\n  constructor(navbar) {\n    super(navbar, 'psv-button--hover-scale psv-gyroscope-button', true);\n\n    /**\n     * @type {PSV.plugins.GyroscopePlugin}\n     * @readonly\n     * @private\n     */\n    this.plugin = this.psv.getPlugin('gyroscope');\n\n    if (this.plugin) {\n      this.plugin.on(EVENTS.GYROSCOPE_UPDATED, this);\n    }\n  }\n\n  /**\n   * @override\n   */\n  destroy() {\n    if (this.plugin) {\n      this.plugin.off(EVENTS.GYROSCOPE_UPDATED, this);\n    }\n\n    delete this.plugin;\n\n    super.destroy();\n  }\n\n  /**\n   * @override\n   */\n  isSupported() {\n    return !this.plugin ? false : { initial: false, promise: this.plugin.prop.isSupported };\n  }\n\n  /**\n   * @summary Handles events\n   * @param {Event} e\n   * @private\n   */\n  handleEvent(e) {\n    if (e.type === EVENTS.GYROSCOPE_UPDATED) {\n      this.toggleActive(e.args[0]);\n    }\n  }\n\n  /**\n   * @override\n   * @description Toggles gyroscope control\n   */\n  onClick() {\n    this.plugin.toggle();\n  }\n\n}\n","import { Object3D, Vector3 } from 'three';\nimport { AbstractPlugin, CONSTANTS, DEFAULTS, registerButton, utils } from '../..';\nimport { EVENTS } from './constants';\nimport { DeviceOrientationControls } from './DeviceOrientationControls';\nimport { GyroscopeButton } from './GyroscopeButton';\n\n\n/**\n * @typedef {Object} PSV.plugins.GyroscopePlugin.Options\n * @property {boolean} [touchmove=true] - allows to pan horizontally when the gyroscope is enabled (requires global `mousemove=true`)\n * @property {boolean} [absolutePosition=false] - when true the view will ignore the current direction when enabling gyroscope control\n * @property {'smooth' | 'fast'} [moveMode='smooth'] - How the gyroscope data is used to rotate the panorama.\n */\n\n\n// add gyroscope button\nDEFAULTS.lang[GyroscopeButton.id] = 'Gyroscope';\nregisterButton(GyroscopeButton, 'caption:right');\n\n\nexport { EVENTS } from './constants';\n\n\nconst direction = new Vector3();\n\n\n/**\n * @summary Adds gyroscope controls on mobile devices\n * @extends PSV.plugins.AbstractPlugin\n * @memberof PSV.plugins\n */\nexport class GyroscopePlugin extends AbstractPlugin {\n\n  static id = 'gyroscope';\n\n  static EVENTS = EVENTS;\n\n  /**\n   * @param {PSV.Viewer} psv\n   * @param {PSV.plugins.GyroscopePlugin.Options} options\n   */\n  constructor(psv, options) {\n    super(psv);\n\n    /**\n     * @member {Object}\n     * @private\n     * @property {Promise<boolean>} isSupported - indicates of the gyroscope API is available\n     * @property {number} alphaOffset - current alpha offset for gyroscope controls\n     * @property {boolean} enabled\n     * @property {boolean} config_moveInertia - original config \"moveInertia\"\n     */\n    this.prop = {\n      isSupported       : this.__checkSupport(),\n      alphaOffset       : 0,\n      enabled           : false,\n      config_moveInertia: true,\n    };\n\n    /**\n     * @member {PSV.plugins.GyroscopePlugin.Options}\n     * @private\n     */\n    this.config = {\n      touchmove       : true,\n      absolutePosition: false,\n      moveMode: 'smooth',\n      ...options,\n    };\n\n    /**\n     * @member {DeviceOrientationControls}\n     * @private\n     */\n    this.controls = null;\n  }\n\n  /**\n   * @package\n   */\n  init() {\n    super.init();\n\n    this.psv.on(CONSTANTS.EVENTS.STOP_ALL, this);\n    this.psv.on(CONSTANTS.EVENTS.BEFORE_ROTATE, this);\n    this.psv.on(CONSTANTS.EVENTS.BEFORE_RENDER, this);\n  }\n\n  /**\n   * @package\n   */\n  destroy() {\n    this.psv.off(CONSTANTS.EVENTS.STOP_ALL, this);\n    this.psv.off(CONSTANTS.EVENTS.BEFORE_ROTATE, this);\n    this.psv.off(CONSTANTS.EVENTS.BEFORE_RENDER, this);\n\n    this.stop();\n\n    delete this.controls;\n\n    super.destroy();\n  }\n\n  /**\n   * @private\n   */\n  handleEvent(e) {\n    switch (e.type) {\n      case CONSTANTS.EVENTS.STOP_ALL:\n        this.stop();\n        break;\n      case CONSTANTS.EVENTS.BEFORE_RENDER:\n        this.__onBeforeRender();\n        break;\n      case CONSTANTS.EVENTS.BEFORE_ROTATE:\n        this.__onBeforeRotate(e);\n        break;\n      default:\n        break;\n    }\n  }\n\n  /**\n   * @summary Checks if the gyroscope is enabled\n   * @returns {boolean}\n   */\n  isEnabled() {\n    return this.prop.enabled;\n  }\n\n  /**\n   * @summary Enables the gyroscope navigation if available\n   * @returns {Promise}\n   * @fires PSV.plugins.GyroscopePlugin.gyroscope-updated\n   * @throws {PSV.PSVError} if the gyroscope API is not available/granted\n   */\n  start() {\n    return this.prop.isSupported\n      .then((supported) => {\n        if (supported) {\n          return this.__requestPermission();\n        }\n        else {\n          utils.logWarn('gyroscope not available');\n          return Promise.reject();\n        }\n      })\n      .then((granted) => {\n        if (granted) {\n          return Promise.resolve();\n        }\n        else {\n          utils.logWarn('gyroscope not allowed');\n          return Promise.reject();\n        }\n      })\n      .then(() => {\n        this.psv.__stopAll();\n\n        // disable inertia\n        this.prop.config_moveInertia = this.psv.config.moveInertia;\n        this.psv.config.moveInertia = false;\n\n        // enable gyro controls\n        if (!this.controls) {\n          this.controls = new DeviceOrientationControls(new Object3D());\n        }\n        else {\n          this.controls.connect();\n        }\n\n        // force reset\n        this.controls.deviceOrientation = null;\n        this.controls.screenOrientation = 0;\n        this.controls.alphaOffset = 0;\n\n        this.prop.alphaOffset = this.config.absolutePosition ? 0 : null;\n        this.prop.enabled = true;\n\n        this.trigger(EVENTS.GYROSCOPE_UPDATED, true);\n      });\n  }\n\n  /**\n   * @summary Disables the gyroscope navigation\n   * @fires PSV.plugins.GyroscopePlugin.gyroscope-updated\n   */\n  stop() {\n    if (this.isEnabled()) {\n      this.controls.disconnect();\n\n      this.prop.enabled = false;\n      this.psv.config.moveInertia = this.prop.config_moveInertia;\n\n      this.trigger(EVENTS.GYROSCOPE_UPDATED, false);\n\n      this.psv.resetIdleTimer();\n    }\n  }\n\n  /**\n   * @summary Enables or disables the gyroscope navigation\n   */\n  toggle() {\n    if (this.isEnabled()) {\n      this.stop();\n    }\n    else {\n      this.start();\n    }\n  }\n\n  /**\n   * @summary Handles gyro movements\n   * @private\n   */\n  __onBeforeRender() {\n    if (!this.isEnabled()) {\n      return;\n    }\n\n    if (!this.controls.deviceOrientation) {\n      return;\n    }\n\n    const position = this.psv.getPosition();\n\n    // on first run compute the offset depending on the current viewer position and device orientation\n    if (this.prop.alphaOffset === null) {\n      this.controls.update();\n      this.controls.object.getWorldDirection(direction);\n\n      const sphericalCoords = this.psv.dataHelper.vector3ToSphericalCoords(direction);\n      this.prop.alphaOffset = sphericalCoords.longitude - position.longitude;\n    }\n    else {\n      this.controls.alphaOffset = this.prop.alphaOffset;\n      this.controls.update();\n      this.controls.object.getWorldDirection(direction);\n\n      const sphericalCoords = this.psv.dataHelper.vector3ToSphericalCoords(direction);\n\n      const target = {\n        longitude: sphericalCoords.longitude,\n        latitude : -sphericalCoords.latitude,\n      };\n\n      // having a slow speed on smalls movements allows to absorb the device/hand vibrations\n      const step = this.config.moveMode === 'smooth' ? 3 : 10;\n      this.psv.dynamics.position.goto(target, utils.getAngle(position, target) < 0.01 ? 1 : step);\n    }\n  }\n\n  /**\n   * @summary Intercepts moves and offsets the alpha angle\n   * @param {external:uEvent.Event} e\n   * @private\n   */\n  __onBeforeRotate(e) {\n    if (this.isEnabled()) {\n      e.preventDefault();\n\n      if (this.config.touchmove) {\n        this.prop.alphaOffset -= e.args[0].longitude - this.psv.getPosition().longitude;\n      }\n    }\n  }\n\n  /**\n   * @summary Detects if device orientation is supported\n   * @returns {Promise<boolean>}\n   * @private\n   */\n  __checkSupport() {\n    if ('DeviceMotionEvent' in window && typeof DeviceMotionEvent.requestPermission === 'function') {\n      return Promise.resolve(true);\n    }\n    else if ('DeviceOrientationEvent' in window) {\n      return new Promise((resolve) => {\n        const listener = (e) => {\n          resolve(e && e.alpha !== null && !isNaN(e.alpha));\n\n          window.removeEventListener('deviceorientation', listener);\n        };\n\n        window.addEventListener('deviceorientation', listener, false);\n        setTimeout(listener, 10000);\n      });\n    }\n    else {\n      return Promise.resolve(false);\n    }\n  }\n\n  /**\n   * @summary Request permission to the motion API\n   * @returns {Promise<boolean>}\n   * @private\n   */\n  __requestPermission() {\n    if ('DeviceMotionEvent' in window && typeof DeviceMotionEvent.requestPermission === 'function') {\n      return DeviceOrientationEvent.requestPermission()\n        .then(response => response === 'granted')\n        .catch(() => false);\n    }\n    else {\n      return Promise.resolve(true);\n    }\n  }\n\n}\n"],"names":["EVENTS","GYROSCOPE_UPDATED","_zee","Vector3","_euler","Euler","_q0","Quaternion","_q1","Math","sqrt","DeviceOrientationControls","object","window","isSecureContext","console","error","scope","EPS","lastQuaternion","rotation","reorder","enabled","deviceOrientation","screenOrientation","alphaOffset","onDeviceOrientationChangeEvent","event","onScreenOrientationChangeEvent","orientation","setObjectQuaternion","quaternion","alpha","beta","gamma","orient","set","setFromEuler","multiply","setFromAxisAngle","connect","DeviceOrientationEvent","undefined","requestPermission","then","response","addEventListener","catch","disconnect","removeEventListener","update","device","MathUtils","degToRad","dot","copy","dispose","GyroscopeButton","navbar","plugin","psv","getPlugin","on","destroy","off","isSupported","initial","promise","prop","handleEvent","e","type","toggleActive","args","onClick","toggle","AbstractButton","id","icon","compass","DEFAULTS","lang","registerButton","direction","GyroscopePlugin","options","__checkSupport","config_moveInertia","config","touchmove","absolutePosition","moveMode","controls","init","CONSTANTS","STOP_ALL","BEFORE_ROTATE","BEFORE_RENDER","stop","__onBeforeRender","__onBeforeRotate","isEnabled","start","supported","__requestPermission","utils","logWarn","Promise","reject","granted","resolve","__stopAll","moveInertia","Object3D","trigger","resetIdleTimer","position","getPosition","getWorldDirection","sphericalCoords","dataHelper","vector3ToSphericalCoords","longitude","target","latitude","step","dynamics","goto","getAngle","preventDefault","DeviceMotionEvent","listener","isNaN","setTimeout","AbstractPlugin"],"mappings":"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"}