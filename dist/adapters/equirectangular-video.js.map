{"version":3,"file":"equirectangular-video.js","sources":["../../src/adapters/shared/AbstractVideoAdapter.js","../../src/adapters/equirectangular-video/index.js"],"sourcesContent":["import { VideoTexture } from 'three';\nimport { AbstractAdapter, CONSTANTS, PSVError } from '../..';\n\n/**\n * @typedef {Object} PSV.adapters.AbstractVideoAdapter.Video\n * @summary Object defining a video\n * @property {string} source\n */\n\n/**\n * @typedef {Object} PSV.adapters.AbstractVideoAdapter.Options\n * @property {boolean} [autoplay=false] - automatically start the video\n * @property {boolean} [muted=autoplay] - initially mute the video\n */\n\n/**\n * @summary Base video adapters class\n * @memberof PSV.adapters\n * @abstract\n * @private\n */\nexport class AbstractVideoAdapter extends AbstractAdapter {\n\n  constructor(psv, options) {\n    super(psv);\n\n    /**\n     * @member {PSV.adapters.AbstractVideoAdapter.Options}\n     * @private\n     */\n    this.config = {\n      autoplay: false,\n      muted   : options?.autoplay ?? false,\n      ...options,\n    };\n\n    /**\n     * @member {HTMLVideoElement}\n     * @private\n     */\n    this.video = null;\n\n    this.psv.on(CONSTANTS.EVENTS.BEFORE_RENDER, this);\n  }\n\n  /**\n   * @override\n   */\n  destroy() {\n    this.psv.off(CONSTANTS.EVENTS.BEFORE_RENDER, this);\n\n    this.__removeVideo();\n\n    super.destroy();\n  }\n\n  /**\n   * @private\n   */\n  handleEvent(e) {\n    /* eslint-disable */\n    switch (e.type) {\n      case CONSTANTS.EVENTS.BEFORE_RENDER:\n        if (this.video) {\n          this.psv.needsUpdate();\n        }\n        break;\n    }\n    /* eslint-enable */\n  }\n\n  /**\n   * @override\n   * @param {PSV.adapters.AbstractVideoAdapter.Video} panorama\n   * @returns {Promise.<PSV.TextureData>}\n   */\n  loadTexture(panorama) {\n    if (typeof panorama !== 'object' || !panorama.source) {\n      return Promise.reject(new PSVError('Invalid panorama configuration, are you using the right adapter?'));\n    }\n\n    if (!this.psv.getPlugin('video')) {\n      return Promise.reject(new PSVError('Video adapters require VideoPlugin to be loaded too.'));\n    }\n\n    const video = this.__createVideo(panorama.source);\n\n    return this.__videoLoadPromise(video)\n      .then(() => {\n        const texture = new VideoTexture(video);\n        return { panorama, texture };\n      });\n  }\n\n  /**\n   * @override\n   */\n  __switchVideo(texture) {\n    let currentTime;\n    let duration;\n    let paused = !this.config.autoplay;\n    let muted = this.config.muted;\n    let volume = 1;\n    if (this.video) {\n      ({ currentTime, duration, paused, muted, volume } = this.video);\n    }\n\n    this.__removeVideo();\n    this.video = texture.image;\n\n    // keep current time when switching resolution\n    if (this.video.duration === duration) {\n      this.video.currentTime = currentTime;\n    }\n\n    // keep volume\n    this.video.muted = muted;\n    this.video.volume = volume;\n\n    // play\n    if (!paused) {\n      this.video.play();\n    }\n  }\n\n  /**\n   * @override\n   */\n  disposeTexture(textureData) {\n    if (textureData.texture) {\n      const video = textureData.texture.image;\n      video.pause();\n      this.psv.container.removeChild(video);\n    }\n    textureData.texture?.dispose();\n  }\n\n  /**\n   * @summary Removes the current video element\n   * @private\n   */\n  __removeVideo() {\n    if (this.video) {\n      this.video.pause();\n      this.psv.container.removeChild(this.video);\n      delete this.video;\n    }\n  }\n\n  /**\n   * @summary Creates a new video element\n   * @memberOf PSV.adapters\n   * @param {string} src\n   * @return {HTMLVideoElement}\n   * @private\n   */\n  __createVideo(src) {\n    const video = document.createElement('video');\n    video.crossOrigin = this.psv.config.withCredentials ? 'use-credentials' : 'anonymous';\n    video.loop = true;\n    video.playsinline = true;\n    video.style.display = 'none';\n    video.muted = this.config.muted;\n    video.src = src;\n    video.preload = 'metadata';\n\n    this.psv.container.appendChild(video);\n\n    return video;\n  }\n\n  /**\n   * @private\n   */\n  __videoLoadPromise(video) {\n    const self = this;\n\n    return new Promise((resolve, reject) => {\n      video.addEventListener('loadedmetadata', function onLoaded() {\n        if (this.video && video.duration === this.video.duration) {\n          resolve(self.__videoBufferPromise(video, this.video.currentTime));\n        }\n        else {\n          resolve();\n        }\n        video.removeEventListener('loadedmetadata', onLoaded);\n      });\n\n      video.addEventListener('error', function onError(err) {\n        reject(err);\n        video.removeEventListener('error', onError);\n      });\n    });\n  }\n\n  /**\n   * @private\n   */\n  __videoBufferPromise(video, currentTime) {\n    return new Promise((resolve) => {\n      function onBuffer() {\n        const buffer = video.buffered;\n        for (let i = 0, l = buffer.length; i < l; i++) {\n          if (buffer.start(i) <= video.currentTime && buffer.end(i) >= video.currentTime) {\n            video.pause();\n            video.removeEventListener('buffer', onBuffer);\n            video.removeEventListener('progress', onBuffer);\n            resolve();\n            break;\n          }\n        }\n      }\n\n      // try to reduce the switching time by preloading in advance\n      // FIXME find a better way ?\n      video.currentTime = Math.min(currentTime + 2000, video.duration.currentTime);\n      video.muted = true;\n\n      video.addEventListener('buffer', onBuffer);\n      video.addEventListener('progress', onBuffer);\n\n      video.play();\n    });\n  }\n\n}\n","import { MathUtils, Mesh, MeshBasicMaterial, SphereGeometry } from 'three';\nimport { CONSTANTS, PSVError } from '../..';\nimport { AbstractVideoAdapter } from '../shared/AbstractVideoAdapter';\n\n/**\n * @typedef {Object} PSV.adapters.EquirectangularVideoAdapter.Video\n * @summary Object defining a video\n * @property {string} source\n */\n\n/**\n * @typedef {Object} PSV.adapters.EquirectangularVideoAdapter.Options\n * @property {boolean} [autoplay=false] - automatically start the video\n * @property {boolean} [muted=autoplay] - initially mute the video\n * @property {number} [resolution=64] - number of faces of the sphere geometry, higher values may decrease performances\n */\n\n\n/**\n * @summary Adapter for equirectangular videos\n * @memberof PSV.adapters\n * @extends PSV.adapters.AbstractAdapter\n */\nexport class EquirectangularVideoAdapter extends AbstractVideoAdapter {\n\n  static id = 'equirectangular-video';\n\n  /**\n   * @param {PSV.Viewer} psv\n   * @param {PSV.adapters.EquirectangularVideoAdapter.Options} options\n   */\n  constructor(psv, options) {\n    super(psv, {\n      resolution: 64,\n      ...options,\n    });\n\n    if (!MathUtils.isPowerOfTwo(this.config.resolution)) {\n      throw new PSVError('EquirectangularVideoAdapter resolution must be power of two');\n    }\n\n    this.SPHERE_SEGMENTS = this.config.resolution;\n    this.SPHERE_HORIZONTAL_SEGMENTS = this.SPHERE_SEGMENTS / 2;\n  }\n\n  /**\n   * @override\n   * @param {PSV.adapters.EquirectangularVideoAdapter.Video} panorama\n   * @returns {Promise.<PSV.TextureData>}\n   */\n  loadTexture(panorama) {\n    return super.loadTexture(panorama)\n      .then(({ texture }) => {\n        const video = texture.image;\n        const panoData = {\n          fullWidth    : video.videoWidth,\n          fullHeight   : video.videoHeight,\n          croppedWidth : video.videoWidth,\n          croppedHeight: video.videoHeight,\n          croppedX     : 0,\n          croppedY     : 0,\n          poseHeading  : 0,\n          posePitch    : 0,\n          poseRoll     : 0,\n        };\n\n        return { panorama, texture, panoData };\n      });\n  }\n\n  /**\n   * @override\n   */\n  createMesh(scale = 1) {\n    const geometry = new SphereGeometry(\n      CONSTANTS.SPHERE_RADIUS * scale,\n      this.SPHERE_SEGMENTS,\n      this.SPHERE_HORIZONTAL_SEGMENTS,\n      -Math.PI / 2\n    )\n      .scale(-1, 1, 1);\n\n    const material = new MeshBasicMaterial();\n\n    return new Mesh(geometry, material);\n  }\n\n  /**\n   * @override\n   */\n  setTexture(mesh, textureData) {\n    mesh.material.map?.dispose();\n    mesh.material.map = textureData.texture;\n\n    this.__switchVideo(textureData.texture);\n  }\n\n}\n"],"names":["AbstractVideoAdapter","psv","options","config","autoplay","muted","video","on","CONSTANTS","EVENTS","BEFORE_RENDER","destroy","off","__removeVideo","handleEvent","e","type","needsUpdate","loadTexture","panorama","source","Promise","reject","PSVError","getPlugin","__createVideo","__videoLoadPromise","then","texture","VideoTexture","__switchVideo","currentTime","duration","paused","volume","image","play","disposeTexture","textureData","pause","container","removeChild","dispose","src","document","createElement","crossOrigin","withCredentials","loop","playsinline","style","display","preload","appendChild","self","resolve","addEventListener","onLoaded","__videoBufferPromise","removeEventListener","onError","err","onBuffer","buffer","buffered","i","l","length","start","end","Math","min","AbstractAdapter","EquirectangularVideoAdapter","resolution","MathUtils","isPowerOfTwo","SPHERE_SEGMENTS","SPHERE_HORIZONTAL_SEGMENTS","panoData","fullWidth","videoWidth","fullHeight","videoHeight","croppedWidth","croppedHeight","croppedX","croppedY","poseHeading","posePitch","poseRoll","createMesh","scale","geometry","SphereGeometry","SPHERE_RADIUS","PI","material","MeshBasicMaterial","Mesh","setTexture","mesh","map","id"],"mappings":"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"}